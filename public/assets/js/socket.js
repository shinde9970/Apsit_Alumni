"use strict";function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,s){if(e){if("string"==typeof e)return _arrayLikeToArray(e,s);var a=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(a="Object"===a&&e.constructor?e.constructor.name:a)||"Set"===a?Array.from(e):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(e,s):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,s){(null==s||s>e.length)&&(s=e.length);for(var a=0,t=new Array(s);a<s;a++)t[a]=e[a];return t}var selectedUser,chats=[],todaysDate=(new Date).toLocaleDateString("en-US",{timeZone:"Asia/Kolkata"}),dateMap=new Map,statusMap=new Map;$(document).ready(function(){var o=io({autoConnect:!1});o.connect(),o.on("my chats",function(e,s,a,t){if(0==$("#user-pane").children().length&&0<a.length){chats=e;for(var n=new Map,r=0;r<e.length;r++)n[e[r].userid]=e[r];s=_toConsumableArray(new Set(s));for(var i=0;i<a.length;i++){var c=n[a[i]];t&&t.includes(c.userid)?s&&s.includes(c.userid)?$("#user-pane").append("\n                        <div data-userid=".concat(c.userid,' class="select-box d-flex">\n                            <div class="status user-online my-auto px-1"><i class="fas fa-circle"></i></div>\n                            <div class="fas fa-user my-auto user-pane-img"></div>\n                            <div class="select-box-username my-auto">&nbsp;').concat(c.username,'</div>\n                            <div class="fas fa-envelope notify text-success ml-auto my-auto"></div>\n                        </div>\n                        ')):$("#user-pane").append("\n                        <div data-userid=".concat(c.userid,' class="select-box d-flex">\n                            <div class="status user-online my-auto px-1"><i class="fas fa-circle"></i></div>\n                            <div class="fas fa-user my-auto user-pane-img"></div>\n                            <div class="select-box-username my-auto">&nbsp;').concat(c.username,'</div>\n                            <div class="notify text-success ml-auto"></div>\n                        </div>\n                        ')):s&&s.includes(c.userid)?$("#user-pane").append("\n                        <div data-userid=".concat(c.userid,' class="select-box d-flex">\n                            <div class="status user-offline my-auto px-1"><i class="fas fa-circle"></i></div>\n                            <div class="fas fa-user my-auto user-pane-img"></div>\n                            <div class="select-box-username my-auto">&nbsp;').concat(c.username,'</div>\n                            <div class="fas fa-envelope notify text-success ml-auto my-auto"></div>\n                        </div>\n                        ')):$("#user-pane").append("\n                        <div data-userid=".concat(c.userid,' class="select-box d-flex">\n                            <div class="status user-offline my-auto px-1"><i class="fas fa-circle"></i></div>\n                            <div class="fas fa-user my-auto user-pane-img"></div>\n                            <div class="select-box-username my-auto">&nbsp;').concat(c.username,'</div>\n                            <div class="notify text-success ml-auto"></div>\n                        </div>\n                        '))}d();for(var l=0;l<t.length;l++)statusMap.set(String(t[l]),!0)}});var s=0;function d(){$(".select-box").click(function(){$("#chat-pane").show("slow"),$("#utils-pane").hide("slow"),$(".select-box").removeClass("selected-box");var e=$(this);e.addClass("selected-box"),selectedUser=e.attr("data-userid"),o.emit("removeUnread",selectedUser),e.children(".notify").removeClass("fas fa-envelope my-auto"),$("#selcted-user-details").removeAttr("hidden"),$("#message-pane").removeAttr("hidden"),$("#type-pane").removeClass("d-none").addClass("d-flex");var s=e.children(".select-box-username").text();$("#chat-username").text(s),statusMap.get(selectedUser)?$("#chat-user-status").text("online"):$("#chat-user-status").text("offline");var e=e.attr("data-userid");$("#chat-username-link").attr("href","/profile/".concat(e));var a=$("#message-pane");a.html(""),dateMap.clear();for(var t=0;t<chats.length;t++){var n=chats[t];if(n.userid==selectedUser&&n.messages){for(var r=0;r<n.messages.length;r++){var i=n.messages[r].timestamp.split(", "),c=i[0],l=i[1],d=new Date(todaysDate),i=new Date(c);dateMap.has(c)||(864e5<d-i?a.append('\n                                    <div class="date-line">\n                                        <span class="date-line-date">'.concat(i.toLocaleDateString("in"),"</span>\n                                    </div>\n                                ")):d-i==864e5?a.append('\n                                    <div class="date-line">\n                                        <span class="date-line-date">yesterday</span>\n                                    </div>\n                                '):todaysDate==c&&a.append('\n                                    <div class="date-line">\n                                        <span class="date-line-date">today</span>\n                                    </div>\n                                '),dateMap.set(c,1)),1==n.messages[r].who?a.append('\n                                <div class="message-rec d-flex flex-row">\n                                    <span class="left-triangle"></span>\n                                    <span class="message">'.concat(n.messages[r].msg,'<span class="msg-ts">').concat(l,"</span></span>\n                                </div>\n                            ")):a.append('\n                                <div class="message-sent d-flex flex-row-reverse">\n                                    <span class="right-triangle"></span>\n                                    <span class="message">'.concat(n.messages[r].msg,'<span class="msg-ts">').concat(l,"</span></span>\n                                </div>\n                            "))}break}}e="message-pane",(e=document.getElementById(e)).scrollTop=e.scrollHeight-e.clientHeight})}o.on("connect_error",function(e){s<=0&&(s+=1,alert("Lost chat server connection!"))}),o.on("private message",function(e){for(var s=e.content,a=e.from,t=e.timestamp,n=0;n<chats.length;n++){var r=chats[n];if(r.userid==a.userid){chats[n].messages.push({who:1,msg:s,timestamp:t});var i=(t=t.split(", "))[0],c=t[1];todaysDate=(new Date).toLocaleString("en-US",{timeZone:"Asia/Kolkata"}).split(", ")[0];var l=$("#message-pane");dateMap.has(i)||(i==todaysDate?l.append('\n                            <div class="date-line">\n                                <span class="date-line-date">today</span>\n                            </div>\n                        '):l.append('\n                            <div class="date-line">\n                                <span class="date-line-date">yesterday</span>\n                            </div>\n                        '),dateMap.set(i,1));i=$("div .select-box[data-userid="+r.userid+"]");i.children(".status").addClass("user-online").removeClass("user-offline"),statusMap.set(String(r.userid),!0),a.userid==selectedUser?l.append('\n                        <div class="message-rec d-flex flex-row">\n                            <span class="left-triangle"></span>\n                            <span class="message">'.concat(s,'<span class="msg-ts">').concat(c,"</span></span>\n                        </div>\n                    ")):(i.children(".notify").addClass("fas fa-envelope my-auto"),o.emit("addUnread",r.userid)),i.parent().prepend(i);break}}n==chats.length&&(chats.push({userid:a.userid,username:a.username,messages:[{who:1,msg:s,timestamp:t}]}),$("#user-pane").prepend("\n                <div data-userid=".concat(a.userid,' class="select-box d-flex">\n                    <div class="status user-online my-auto px-1"><i class="fas fa-circle"></i></div>\n                    <div class="fas fa-user my-auto user-pane-img"></div>\n                    <div class="select-box-username my-auto">&nbsp;').concat(a.username,'</div>\n                    <div class="fas fa-envelope notify text-success ml-auto my-auto"></div>\n                </div>\n            ')),d(),statusMap.set(String(a.userid),!0))}),o.on("userConnected",function(e){e==selectedUser&&$("#chat-user-status").text("online");var s=$("div .select-box[data-userid="+e+"]");0<s.length&&(s.children(".status").addClass("user-online").removeClass("user-offline"),statusMap.set(e,!0))}),o.on("userDisconnected",function(e){e==selectedUser&&$("#chat-user-status").text("offline");var s=$("div .select-box[data-userid="+e+"]");0<s.length&&(s.children(".status").addClass("user-offline").removeClass("user-online"),statusMap.set(e,!1))}),$("#send-btn").click(function(){var e=$(".selected-box").attr("data-userid"),s=$("#send-message").val(),a=(new Date).toLocaleString("en-US",{timeZone:"Asia/Kolkata"}).split(", "),t=a[0],n=a[1].slice(0,-6)+" "+a[1].slice(-2),r=t+", "+n;if(e&&s){o.emit("private message",{content:s,to:e,timestamp:r}),$("#send-message").val("");for(var i=0;i<chats.length;i++){var c=chats[i];if(c.userid==e){chats[i].messages.push({who:0,msg:s,timestamp:r});c=$("div .select-box[data-userid="+c.userid+"]");c.parent().prepend(c);break}}var a=$("#message-pane");todaysDate=t,dateMap.has(t)||(a.append('\n                    <div class="date-line">\n                        <span class="date-line-date">today</span>\n                    </div>\n                '),dateMap.set(t,1)),a.append('\n                <div class="message-sent d-flex flex-row-reverse">\n                    <span class="right-triangle"></span>\n                    <span class="message">'.concat(s,'<span class="msg-ts">').concat(n,"</span></span>\n                </div>\n            ")),a="message-pane",n=document.getElementById(a),$("#"+a).animate({scrollTop:n.scrollHeight-n.clientHeight},500)}}),$("#chat-pane").hide(),$(".back-to-top .fa-arrow-up").hide(),$("#back-btn").on("click",function(){selectedUser="",$(".select-box").removeClass("selected-box"),$("#utils-pane").show("slow"),$("#chat-pane").hide("slow")});var a=$("#menu-container");$("#menu-btn").on("click",function(){a.show(50),$("body").on("click",function(e){$(e.target).closest("#menu-container").length||$(e.target).closest("#menu-btn").length||(a.hide(50),$("body").off())})}),$("#menu-option-clear").on("click",function(){for(var e=0;e<chats.length;e++)if(chats[e].userid==selectedUser){chats[e].messages=[];break}o.emit("clearChat",selectedUser),$("#message-pane").html(""),a.hide(50)}),$("#menu-option-delete").on("click",function(){for(var e=0;e<chats.length;e++)if(chats[e].userid==selectedUser){chats.splice(e,1);break}o.emit("deleteChat",selectedUser),$("div .select-box[data-userid="+selectedUser+"]").remove(),$("#back-btn").click(),a.hide(50),$("#menu-btn").tooltip()})});